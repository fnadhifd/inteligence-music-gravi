<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>GRAVI AI Ã— BMW M â€“ Vision Mist Aura</title>
<style>
:root{
  --m-blue:#007bff;--m-darkblue:#002bff;--m-red:#ff003c;
  --m-purple:#a000ff;--gravi-cyan:#00fff2;--gravi-white:#e6f4ff;

  /* Apple Flow palette */
  --af-deep:#001917;       /* hijau-hitam pekat */
  --af-core:#002622;       /* hijau tua gelap */
  --af-cyan-soft: rgba(0,232,208,.20);
  --af-cyan-soft2: rgba(0,190,170,.16);

  /* Apple Music Colors for Contrast */
  --am-text-light: #ffffff;
  --am-text-dim: rgba(255, 255, 255, 0.55);
  --am-active-text: #ffffff;
}
*{box-sizing:border-box; font-family: Inter, -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;}
body{
  margin:0;background:#000;display:flex;justify-content:center;align-items:center;
  height:100vh;overflow:hidden;color:var(--am-text-light);
}

/* Kunci Scroll saat Fullscreen Cover Aktif */
body.scroll-locked {
  overflow: hidden !important;
}

/* Intro */
.intro{position:absolute;inset:0;background:#000;display:flex;flex-direction:column;
  justify-content:center;align-items:center;text-align:center;transition:opacity 2s ease;z-index:100;}
.intro h1{font-size: clamp(1.5rem, 4vw, 2.5rem);letter-spacing:1px;background:linear-gradient(90deg,var(--gravi-cyan),var(--m-blue),var(--m-purple));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;opacity:0;animation:fadeInText 3s ease forwards;}
.start-btn{margin-top:20px;background:linear-gradient(90deg,var(--m-blue),var(--m-purple));border:none;color:#fff;font-size:1rem;
  font-weight:600;padding:12px 28px;border-radius:16px;cursor:pointer;opacity:0;animation:fadeInButton 4s ease forwards;
  box-shadow:0 0 20px rgba(0,200,255,.4);transition:transform .3s,box-shadow .3s;}
.start-btn:hover{transform:scale(1.05);box-shadow:0 0 35px rgba(0,200,255,.7);}
@keyframes fadeInText{0%{opacity:0;transform:translateY(20px)}100%{opacity:1;transform:translateY(0)}}
@keyframes fadeInButton{0%{opacity:0;transform:translateY(40px)}100%{opacity:1;transform:translateY(0)}}

/* Frame (Default) */
.frame{position:relative;width:100vw;height:100vh;border-radius:0;background:#000;overflow:hidden;opacity:0;transition:opacity 2s ease;}

/* Blur Background (di luar frame untuk Fullscreen) */
.blur-bg{
  position:fixed; /* Gunakan fixed agar menutupi seluruh viewport */
  inset:-20px;
  filter:blur(100px); /* Increased blur and larger inset */
  background:radial-gradient(circle at 50% 50%, rgba(0,0,0,0.7), #000);
  z-index:1;
  transition:background 600ms ease, opacity 400ms ease, filter 400ms ease;
  pointer-events: none;
  opacity: 0; /* Mulai tersembunyi */
}
/* Overlay untuk efek gelap di atas background blur */
.dim-overlay{position:absolute;inset:0;background:rgba(0,0,0,.25);
  opacity:0;transition:opacity .4s ease;pointer-events:none;z-index:10;}
.dim-overlay.on{opacity:.45;}

/* Default Animated Edge (RGB/GRAVI Aura) - Di dalam frame */
.frame::before{content:'';position:absolute;inset:0;padding:6px;
  background:linear-gradient(120deg,var(--m-blue),var(--m-purple),var(--gravi-cyan),var(--m-red),var(--m-darkblue));
  background-size:400% 400%;-webkit-mask:linear-gradient(#000 0 0) content-box,linear-gradient(#000 0 0);
  -webkit-mask-composite:xor;mask-composite:exclude;filter:blur(6px);animation:appleAura 10s ease-in-out infinite;z-index:11;}

@keyframes appleAura{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
@keyframes rgbAura{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}

/* Buttons Top & Bottom */
.logout-btn,.change-btn{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.2);color:#fff;
  padding:8px 14px;border-radius:12px;font-size:.9rem;cursor:pointer;backdrop-filter:blur(10px);
  z-index:30;transition:.3s;margin-right:10px;}
.logout-btn:hover,.change-btn:hover{background:rgba(255,255,255,.1);}
.top-buttons{position:fixed;top:20px;left:20px;display:flex;z-index:30;transition:opacity 0.5s, visibility 0.5s;}
.buttons{position:fixed;bottom:18px;left:50%;transform:translateX(-50%);display:flex;gap:10px;z-index:40;transition:opacity 0.5s, visibility 0.5s;}
.btn{background:rgba(30,30,30,.85);color:#fff;border:1px solid rgba(255,255,255,.2);
  padding:10px 18px;border-radius:12px;cursor:pointer;backdrop-filter:blur(10px);font-weight:600;transition:.3s;}
.btn:hover{background:rgba(255,255,255,.1);}

/* Content - Container Utama Scrollable */
.content{position:absolute;inset:0;padding:64px 24px 120px;display:flex;flex-direction:column;
  align-items:center;gap:24px;z-index:20;overflow-y:auto;overflow-x:hidden;transition:opacity 0.5s, visibility 0.5s;}
.title{font-weight:700;opacity:.9}
.connect-btn{background:linear-gradient(90deg,#1db954,#1ed760);border:none;padding:12px 28px;border-radius:16px;
  font-weight:700;color:#fff;cursor:pointer;box-shadow:0 0 25px rgba(30,215,96,.4);transition:.3s;}
.connect-btn:hover{box-shadow:0 0 40px rgba(30,215,96,.8);}

/* Playlist grid */
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:18px;width:min(900px,92vw);}
.card{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08);border-radius:22px;padding:14px;
  transition:transform .25s,box-shadow .25s;backdrop-filter:blur(8px); cursor: pointer;}
.card:hover{transform:translateY(-4px) scale(1.02);box-shadow:0 10px 30px rgba(0,0,0,.45);}
.thumb{width:100%;aspect-ratio:1/1;border-radius:16px;object-fit:cover;box-shadow:0 8px 24px rgba(0,0,0,.35);}
.label{margin-top:10px;font-weight:600;opacity:.9;text-align:center;}

/* Playlist view + search */
.playlist-view{display:none;flex-direction:column;align-items:center;width:100%;animation:fadeInView .8s ease forwards;}
@keyframes fadeInView{from{opacity:0;transform:translateY(20px);}to{opacity:1;transform:translateY(0);}}
.search-bar{width:min(500px,90%);padding:10px 16px;border:none;border-radius:16px;margin-bottom:20px;
  background:rgba(255,255,255,.08);color:white;backdrop-filter:blur(8px);font-size:1rem;outline:none;}
.song-list{display:flex;flex-direction:column;gap:10px;width:min(700px,92vw);}
.song-item{display:flex;align-items:center;gap:12px;background:rgba(255,255,255,.05);padding:10px 14px;
  border-radius:14px;backdrop-filter:blur(8px);cursor:pointer;transition:background .3s,transform .2s;}
.song-item:hover{background:rgba(255,255,255,.12);transform:scale(1.02);}
.song-cover{width:50px;height:50px;border-radius:10px;object-fit:cover;}
.song-info{flex:1;}
.song-title{font-weight:600;}
.song-artist{font-size:.85rem;opacity:.7;}
.back-btn{background:rgba(255,255,255,.08);border:none;color:white;padding:10px 18px;border-radius:12px;
  margin-bottom:20px;cursor:pointer;backdrop-filter:blur(8px);font-weight:600;transition:.3s;}
.back-btn:hover{background:rgba(255,255,255,.15);}

/* Now Playing (Normal View) */
.np{
  display:flex;flex-direction:column;align-items:center;gap:10px;margin-top:10px;
  transition: all 0.5s ease-in-out;
  z-index: 21; /* Pastikan di atas content lain */
}
.np-cover{width:260px;height:260px;border-radius:22px;object-fit:cover;box-shadow:0 20px 60px rgba(0,0,0,.6);
  cursor:pointer;transition:transform .55s cubic-bezier(.2,.8,.2,1), box-shadow .55s, border-radius .55s, width .55s, height .55s;}
.np-title{font-size:1.25rem;font-weight:800; text-align: center;}
.np-artist{opacity:.75; text-align: center;}

/* NOW PLAYING FULLSCREEN COVER MODE */
.np.fullscreen {
  position: fixed; 
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  justify-content: center;
  align-items: center;
  z-index: 50; 
  margin-top: 0;
  padding-top: 0; 
  padding-bottom: 50px; 
  display: flex;
  flex-direction: column;
}
/* Overlay khusus fullscreen */
.np.fullscreen::before {
    content: '';
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.7); /* Overlay hitam transparan agar cover menonjol */
    z-index: -1;
}

.np.fullscreen .close-btn {
    display: flex; 
    position: fixed; 
    top: 20px;
    right: 20px;
    background: rgba(255, 255, 255, 0.1);
    color: white;
    border: none;
    padding: 10px 14px;
    border-radius: 50%;
    cursor: pointer;
    backdrop-filter: blur(15px);
    font-size: 1.2rem;
    line-height: 1;
    font-weight: 300;
    transition: background 0.3s;
    z-index: 60; 
    width: 40px;
    height: 40px;
    align-items: center;
    justify-content: center;
    box-shadow: 0 0 10px rgba(0,0,0,0.5);
}
.np.fullscreen .close-btn:hover {
    background: rgba(255, 255, 255, 0.2);
}


.np.fullscreen .np-cover {
  width: min(70vw, 500px); 
  height: min(70vw, 500px);
  border-radius: 20px; 
  box-shadow: 0 30px 80px rgba(0, 0, 0, 0.8);
  margin-bottom: 20px; 
}

/* TAMPILKAN Judul dan Artis saat Fullscreen, beri style besar */
.np.fullscreen .np-title {
  display: block; 
  font-size: clamp(1.8rem, 4vw, 2.5rem); 
  font-weight: 800;
  margin-top: 10px;
  line-height: 1.1;
}
.np.fullscreen .np-artist {
  display: block;
  font-size: clamp(1.2rem, 2vw, 1.5rem); 
  opacity: 0.9;
  margin-top: 5px;
}

/* =========================
   ðŸŽµ APPLE FLOW â€“ SKYFALL (OPTIMIZED)
   ========================= */
.frame.appleflow::before{
  animation:none;
  opacity:0;
  pointer-events: none;
}
.frame.appleflow{
  background: radial-gradient(80% 80% at 50% 50%, var(--af-deep) 0%, #000 70%);
}
.appleflow-active #blurBg{ /* Selector untuk blur-bg saat mode aktif */
  inset:-12%;
  background:
    radial-gradient(45% 45% at 52% 48%, var(--af-core) 0%, #000 70%),
    radial-gradient(38% 38% at 62% 42%, var(--af-cyan-soft), rgba(0,0,0,0) 70%),
    radial-gradient(32% 32% at 38% 62%, var(--af-cyan-soft2), rgba(0,0,0,0) 72%);
  filter: blur(70px);
  transform: rotate(0deg) scale(1.04); will-change: transform;
  animation: af-rotate 32s linear infinite;
  opacity:1; /* Diubah dari .95 ke 1 agar terlihat */
}
@keyframes af-rotate{from{transform:rotate(0deg) scale(1.04)}to{transform:rotate(360deg) scale(1.04)}}
.frame.appleflow .content,.frame.appleflow .buttons,.frame.appleflow .top-buttons{backdrop-filter:blur(20px);transition:backdrop-filter .6s ease;}
body.appleflow-active{background:#000;}
@media (prefers-reduced-motion: reduce){.appleflow-active #blurBg{animation:none !important;}}

/* Media Queries untuk Ponsel */
@media (max-width: 768px) {
  .content {
    padding: 20px 10px 100px; /* Padding lebih kecil di mobile */
    gap: 16px;
  }
  .top-buttons{top: 10px; left: 10px;}
  
  .grid{grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:12px;width:95vw;}
  .card{padding: 8px; border-radius: 16px;}
  .thumb{border-radius: 12px;}
  
  .frame .np-cover{
    width: min(80vw, 250px);
    height: min(80vw, 250px);
  }

  .np.fullscreen .np-cover {
    width: 90vw;
    height: 90vw;
    max-height: 90vh;
    max-width: 90vh;
  }
  .np.fullscreen .close-btn {
      top: 15px;
      right: 15px;
      width: 36px;
      height: 36px;
      font-size: 1rem;
  }
}
</style>
</head>
<body>

<div class="intro" id="intro">
  <h1>Welcome to GRAVI Inteligence Music Experience</h1>
  <button class="start-btn" id="startBtn">Start Experience</button>
</div>

<!-- Blur Background tetap di luar frame, tapi opacity-nya dikontrol -->
<div class="blur-bg" id="blurBg"></div>

<div class="frame" id="frame">
  <div class="dim-overlay" id="dim"></div>

  <div class="top-buttons" id="topButtons" style="display:none; opacity: 1; visibility: visible;">
    <button id="logoutBtn" class="logout-btn">Log Out</button>
    <button id="changeAccount" class="change-btn">Change Account</button>
  </div>

  <div class="content" id="content" style="opacity: 1; visibility: visible;">
    <h2 class="title" id="sectionTitle">Connect your Spotify</h2>
    <button id="connectSpotify" class="connect-btn">Connect Spotify</button>
    <div id="playlistGrid" class="grid" style="display:none;"></div>

    <div id="playlistView" class="playlist-view">
      <button id="backBtn" class="back-btn">â¬… Kembali</button>
      <input id="searchBar" class="search-bar" type="text" placeholder="Cari lagu di playlist ini..."/>
      <div id="songList" class="song-list"></div>
    </div>
    
    <!-- Bagian NP (Now Playing) -->
    <div id="nowPlaying" class="np" style="display:none;">
      <button id="closeFullscreenBtn" class="close-btn" style="display: none;">âœ•</button>
      <img id="npCover" class="np-cover" src="" alt="Album Cover">
      <div class="np-title" id="npTitle"></div>
      <div class="np-artist" id="npArtist"></div>
    </div>
    
  </div>
  
</div>

<div class="buttons" id="bottomBtns" style="display:none; opacity: 1; visibility: visible;">
  <button id="appleBtn" class="btn">Apple Flow</button>
  <button id="rgbBtn" class="btn">RGB Live</button>
</div>

<script>
  /* =======================================
     AUDIO FX (Sound Clicks)
     ======================================= */
  const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  let uiBuffer = null;
  // Placeholder karena tidak bisa menggunakan file lokal (intro.mp3)
  // Ganti URL ini dengan URL host file intro.mp3 Anda
  // Untuk keperluan demo di sini, saya menggunakan placeholder file audio kecil
  const uiAudioPath = 'https://cdn.jsdelivr.net/gh/Tonejs/Tone.js/examples/audio/casio/sines/C3.mp3'; 
  
  // Audio Player untuk Musik/Preview (Jangan Ganggu Sound FX)
  let audioPreview = new Audio();
  
  // Fungsi untuk memuat dan mendekode UI Sound
  fetch(uiAudioPath)
    .then(r => r.arrayBuffer())
    .then(b => audioCtx.decodeAudioData(b))
    .then(d => (uiBuffer = d))
    .catch(e => console.log("UI sound failed to load:", e));

  // Fungsi untuk memainkan UI Sound (tidak akan bentrok dengan audioPreview)
  function playUISound(v = 0.3) { 
    if (!uiBuffer) return; 
    audioCtx.resume(); 
    const s = audioCtx.createBufferSource(); 
    const g = audioCtx.createGain(); 
    g.gain.value = v; 
    s.buffer = uiBuffer; 
    s.connect(g).connect(audioCtx.destination); 
    s.start(0); 
  }
  
  // Tambahkan listener ke semua tombol (seleksi umum)
  function setupButtonSoundEffects() {
    const buttons = document.querySelectorAll('button, .card, .song-item');
    buttons.forEach(btn => {
      // Pastikan tidak menambahkan event jika sudah ada
      if (!btn.dataset.hasSound) {
        btn.addEventListener('click', () => playUISound(), { once: false });
        btn.dataset.hasSound = 'true';
      }
    });
  }
  
  // Panggil setelah DOM dimuat dan setelah playlist di-render
  document.addEventListener('DOMContentLoaded', setupButtonSoundEffects);
  
  /* =======================================
     APP LOGIC & DOM ELEMENTS
     ======================================= */

  const intro = document.getElementById('intro'),
        frame = document.getElementById('frame'),
        bottomBtns = document.getElementById('bottomBtns');
  const blurBg = document.getElementById('blurBg');
  const connectBtn=document.getElementById('connectSpotify');
  const logoutBtn=document.getElementById('logoutBtn');
  const changeBtn=document.getElementById('changeAccount');
  const topButtons=document.getElementById('topButtons');
  const grid=document.getElementById('playlistGrid');
  const playlistView=document.getElementById('playlistView');
  const backBtn=document.getElementById('backBtn');
  const searchBar=document.getElementById('searchBar');
  const songList=document.getElementById('songList');
  const np=document.getElementById('nowPlaying');
  const npC=document.getElementById('npCover'),
        npT=document.getElementById('npTitle'),
        npA=document.getElementById('npArtist');
  const dim=document.getElementById('dim');
  const closeFsBtn = document.getElementById('closeFullscreenBtn');

  /* Intro Logic */
  document.getElementById('startBtn').onclick=()=>{
    playUISound(); // Panggil sound FX
    intro.style.opacity='0';
    setTimeout(()=>{ 
      intro.style.display='none'; 
      frame.style.opacity='1'; 
      bottomBtns.style.display='flex';
      blurBg.style.opacity = '1'; // Tampilkan blur BG default saat app start
    },2000);
  };

  /* Mode Switch (Apple Flow & RGB) */
  document.getElementById('appleBtn').onclick=()=>{
    // Sound FX sudah dipanggil via setupButtonSoundEffects
    frame.classList.remove('rgb');
    
    if(frame.classList.contains('appleflow')){
      frame.classList.remove('appleflow');
      // Kembali ke default aura
      frame.style.setProperty('--m-blue', '#007bff');
      frame.style.setProperty('--m-purple', '#a000ff');
      frame.style.setProperty('--gravi-cyan', '#00fff2');
      frame.style.setProperty('--m-red', '#ff003c');
      frame.style.setProperty('--m-darkblue', '#002bff');
      
      // Kembali ke default blur bg
      blurBg.style.animation='appleAura 10s ease-in-out infinite';
      blurBg.style.filter='blur(100px)';
      blurBg.style.background='radial-gradient(circle at 50% 50%, rgba(0,0,0,0.7), #000)';

    } else {
      frame.classList.add('appleflow');
      // set ulang gradient Apple Flow (menimpa adaptAura jika sedang aktif)
      blurBg.style.background =
        'radial-gradient(45% 45% at 52% 48%, var(--af-core) 0%, #000 70%),' +
        'radial-gradient(38% 38% at 62% 42%, var(--af-cyan-soft), rgba(0,0,0,0) 70%),' +
        'radial-gradient(32% 32% at 38% 62%, var(--af-cyan-soft2), rgba(0,0,0,0) 72%)';
      blurBg.style.filter='blur(70px)';
      blurBg.style.animation='af-rotate 32s linear infinite';
      
      // Matikan bingkai aura default/rgb saat mode appleflow aktif
      frame.style.setProperty('--m-blue', 'rgba(0,0,0,0)');
      frame.style.setProperty('--m-purple', 'rgba(0,0,0,0)');
      frame.style.setProperty('--gravi-cyan', 'rgba(0,0,0,0)');
      frame.style.setProperty('--m-red', 'rgba(0,0,0,0)');
      frame.style.setProperty('--m-darkblue', 'rgba(0,0,0,0)');
    }
    document.body.classList.toggle('appleflow-active');
  };

  document.getElementById('rgbBtn').onclick=()=>{
    // Sound FX sudah dipanggil via setupButtonSoundEffects
    frame.classList.add('rgb');
    frame.classList.remove('appleflow');
    document.body.classList.remove('appleflow-active');
    
    // Kembalikan warna default aura
    frame.style.setProperty('--m-blue', '#007bff');
    frame.style.setProperty('--m-purple', '#a000ff');
    frame.style.setProperty('--gravi-cyan', '#00fff2');
    frame.style.setProperty('--m-red', '#ff003c');
    frame.style.setProperty('--m-darkblue', '#002bff');
    
    // Set blur bg ke RGB animation
    blurBg.style.animation='rgbAura 4s ease-in-out infinite';
    blurBg.style.filter='blur(100px)'; 
    blurBg.style.background='radial-gradient(circle at 50% 50%, rgba(0,0,0,0.7), #000)';
  };

  /* Spotify Auth/API Setup (Sama seperti sebelumnya) */
  const CLIENT_ID="a4c46dd220374fc586a40f8450993f5a";
  const REDIRECT_URI="https://inteligence-music-gravi.vercel.app/";
  const SCOPES="user-read-currently-playing user-read-playback-state playlist-read-private user-library-read";
  const saveT=t=>localStorage.setItem('spotify_token',t), getT=()=>localStorage.getItem('spotify_token');

  const url=new URLSearchParams(location.search), code=url.get('code');

  if(!code){
    const t=getT();
    if(t) onReady(t);
    else{
      connectBtn.onclick=()=>{
        // Sound FX sudah dipanggil via setupButtonSoundEffects
        location.href=`https://accounts.spotify.com/authorize?client_id=${CLIENT_ID}&response_type=code&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&scope=${encodeURIComponent(SCOPES)}`;
      };
    }
  }else{
    // Ini hanya untuk demo, API Token di canvas akan di-handle oleh environment
    fetch(`/api/token?code=${code}`).then(r=>r.json()).then(d=>{
      saveT(d.access_token);
      history.replaceState({},document.title,location.pathname);
      onReady(d.access_token);
    });
  }

  function onReady(token){
    connectBtn.style.display='none';
    topButtons.style.display='flex';
    topButtons.style.opacity = '1';
    loadPlaylists(token);
    pollNowPlaying(token);
    setInterval(()=>pollNowPlaying(token),8000);
  }

  /* Logout & Change Account */
  logoutBtn.onclick=()=>{ 
    // Sound FX sudah dipanggil via setupButtonSoundEffects
    localStorage.removeItem('spotify_token'); 
    location.reload(); 
  };
  changeBtn.onclick=()=>{ 
    // Sound FX sudah dipanggil via setupButtonSoundEffects
    localStorage.removeItem('spotify_token'); 
    const authURL=`https://accounts.spotify.com/authorize?client_id=${CLIENT_ID}&response_type=code&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&scope=${encodeURIComponent(SCOPES)}&show_dialog=true`;
    window.location.href=authURL;
  };

  /* Load playlists (Sama seperti sebelumnya) */
  async function loadPlaylists(t){
    grid.style.display='grid'; grid.innerHTML="";
    document.getElementById('sectionTitle').textContent='Your Playlists';
    try {
        const r=await fetch(`https://api.spotify.com/v1/me/playlists?limit=50`,{headers:{Authorization:`Bearer ${t}`}});
        if(!r.ok) return; const d=await r.json(); d.items.forEach(p=>grid.appendChild(makeCard(p)));
        // Panggil setupButtonSoundEffects lagi setelah card di-render
        setupButtonSoundEffects(); 
    } catch (e) {
        console.error("Failed to load playlists:", e);
    }
  }

  function makeCard(p){
    const c=document.createElement('div'); c.className='card';
    c.onclick=()=>{ openPlaylist(p); }; // Sound FX akan dipanggil oleh listener umum
    const img=document.createElement('img'); img.className='thumb';
    img.src=p.images && p.images[0]? p.images[0].url : 'https://placehold.co/150x150/1C1C1E/FFFFFF?text=Playlist';
    const lab=document.createElement('div'); lab.className='label'; lab.textContent=p.name||'Playlist';
    c.append(img,lab); return c;
  }

  async function openPlaylist(p){
    grid.style.display='none'; playlistView.style.display='flex';
    document.getElementById('sectionTitle').textContent=p.name;
    const token=getT(); 
    try {
        const r=await fetch(p.tracks.href,{headers:{Authorization:`Bearer ${token}`}});
        if(!r.ok) return; const d=await r.json(); renderSongs(d.items);
    } catch (e) {
        console.error("Failed to load songs:", e);
    }
  }

  function renderSongs(items){
    songList.innerHTML='';
    items.forEach(i=>{
      const t=i.track; if(!t) return;
      const div=document.createElement('div'); div.className='song-item';
      const img=document.createElement('img'); img.src=t.album.images[0]?.url||'https://placehold.co/50x50/1C1C1E/FFFFFF?text=Album'; img.className='song-cover';
      const info=document.createElement('div'); info.className='song-info';
      const title=document.createElement('div'); title.className='song-title'; title.textContent=t.name;
      const artist=document.createElement('div'); artist.className='song-artist'; artist.textContent=t.artists.map(a=>a.name).join(', ');
      info.append(title,artist); div.append(img,info);
      div.onclick=()=>playPreview(t); songList.append(div);
    });
    // Panggil setupButtonSoundEffects lagi setelah song list di-render
    setupButtonSoundEffects(); 
  }

  /* Fullscreen Cover Toggle & Play/Pause */
  function toggleFullscreenCover(state) {
    const isReady = getT();
    np.classList.toggle('fullscreen', state);
    document.body.classList.toggle('scroll-locked', state);
    
    const visibility = state ? 'hidden' : 'visible';
    const opacity = state ? '0' : '1';
    
    closeFsBtn.style.display = state ? 'flex' : 'none';

    topButtons.style.visibility = visibility;
    topButtons.style.opacity = opacity;
    
    bottomBtns.style.visibility = visibility;
    bottomBtns.style.opacity = opacity;
    
    // Pastikan konten utama tidak bisa discroll saat fullscreen, 
    // tetapi masih bisa di-scroll saat tidak fullscreen
    document.getElementById('content').style.overflowY = state ? 'hidden' : 'auto';

    if (!state) {
      np.style.display = 'flex';
      if (isReady) {
        bottomBtns.style.display = 'flex';
        topButtons.style.display = 'flex';
      }
    } 
  }
  
  // Single Click Handler untuk Cover (Toggle Fullscreen + Play/Pause)
  npC.onclick = () => {
      // 1. Handle Play/Pause
      if (audioPreview.src) { 
          if (audioPreview.paused) {
              audioPreview.play();
          } else {
              audioPreview.pause();
          }
      }
      
      // 2. Toggle Fullscreen State
      const isFullscreen = np.classList.contains('fullscreen');
      toggleFullscreenCover(!isFullscreen);
  };
  
  // Handler untuk tombol Close
  closeFsBtn.onclick = () => {
      // Sound FX sudah dipanggil via setupButtonSoundEffects
      toggleFullscreenCover(false);
  };
  
  /* Play preview */
  function playPreview(track){
    // Sound FX sudah dipanggil via setupButtonSoundEffects
    if(audioPreview) audioPreview.pause();
    
    if(track.preview_url){ 
        audioPreview.src=track.preview_url; 
        audioPreview.play(); 
    } else { 
        console.warn("Preview lagu tidak tersedia ðŸ˜¢"); 
    }
    
    const cover=track.album.images[0]?.url || 'https://placehold.co/260x260/1C1C1E/FFFFFF?text=No+Cover';
    npC.src=cover; npT.textContent=track.name; npA.textContent=track.artists.map(a=>a.name).join(', ');
    np.style.display='flex';
    adaptAura(cover);
    dim.classList.add('on');
    
    if (np.classList.contains('fullscreen')) {
        toggleFullscreenCover(false);
    }
  }
  
  /* Search filter (Sama seperti sebelumnya) */
  searchBar.addEventListener('input',()=>{
    const q=searchBar.value.toLowerCase();
    document.querySelectorAll('.song-item').forEach(it=>{
      const text=it.textContent.toLowerCase();
      it.style.display=text.includes(q)?'flex':'none';
    });
  });

  /* Back button */
  backBtn.onclick=()=>{
    // Sound FX sudah dipanggil via setupButtonSoundEffects
    playlistView.style.display='none';
    grid.style.display='grid';
    document.getElementById('sectionTitle').textContent='Your Playlists';
  };

  /* Now Playing polling (Sama seperti sebelumnya) */
  async function pollNowPlaying(t){
    try{
      const r=await fetch(`https://api.spotify.com/v1/me/player/currently-playing`,{headers:{Authorization:`Bearer ${t}`}});
      if(r.status===204){ 
        dim.classList.remove('on'); 
        np.style.display='none'; 
        
        // --- Reset Blur BG when no song is playing ---
        if(!frame.classList.contains('appleflow')){
          blurBg.style.background='radial-gradient(circle at 50% 50%, rgba(0,0,0,0.7), #000)';
          blurBg.style.filter='blur(100px)';
          if(frame.classList.contains('rgb')){
             blurBg.style.animation='rgbAura 4s ease-in-out infinite';
          } else {
             blurBg.style.animation='appleAura 10s ease-in-out infinite';
          }
        } else {
          blurBg.style.background =
            'radial-gradient(45% 45% at 52% 48%, var(--af-core) 0%, #000 70%),' +
            'radial-gradient(38% 38% at 62% 42%, var(--af-cyan-soft), rgba(0,0,0,0) 70%),' +
            'radial-gradient(32% 32% at 38% 62%, var(--af-cyan-soft2), rgba(0,0,0,0) 72%)';
          blurBg.style.filter='blur(70px)';
          blurBg.style.animation='af-rotate 32s linear infinite';
        }
        // --- End Reset ---

        return; 
      }
      const d=await r.json(); if(!d?.item) return;
      const c=d.item.album.images[0].url || 'https://placehold.co/260x260/1C1C1E/FFFFFF?text=No+Cover';
      
      npC.src=c; npT.textContent=d.item.name; npA.textContent=d.item.artists.map(a=>a.name).join(', ');
      np.style.display='flex';
      adaptAura(c);
      dim.classList.add('on');
      
      if (np.classList.contains('fullscreen')) {
        if (npT.textContent !== d.item.name) {
             toggleFullscreenCover(false);
        }
      }
      
    }catch(e){console.error("Polling error:", e);}
  }
  
  /* Aura adapt + blur (Sama seperti sebelumnya) */
  function adaptAura(u){
    if (!blurBg) return; 
    
    if(frame.classList.contains('appleflow')) return; 

    const i=new Image(); i.crossOrigin='anonymous'; i.src=u;
    i.onload=()=>{
      const c=document.createElement('canvas'), x=c.getContext('2d',{willReadFrequently:true});
      c.width=64; c.height=64; x.drawImage(i,0,0,64,64);
      const dt=x.getImageData(0,0,64,64).data;
      let r=0,g=0,b=0,cnt=0;
      for(let k=0;k<dt.length;k+=4){ r+=dt[k]; g+=dt[k+1]; b+=dt[k+2]; cnt++; }
      r=Math.round(r/cnt); g=Math.round(g/cnt); b=Math.round(b/cnt);
      
      const newAuraBg =
        `radial-gradient(circle at center, rgba(${r},${g},${b},0.40) 0%, rgba(0,0,0,0.88) 50%, #000000 100%)`;
      
      blurBg.style.background = newAuraBg;
      blurBg.style.filter='blur(100px)'; 
      blurBg.style.opacity='1';
      blurBg.style.animation='none';
    };
  }
</script>
</body>
</html>
