<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>GRAVI AI × BMW M – Intelligence Music Frame</title>
<style>
:root{
  --m-blue:#007bff;--m-darkblue:#002bff;--m-red:#ff003c;
  --m-purple:#a000ff;--gravi-cyan:#00fff2;--gravi-white:#e6f4ff;
}
body{
  margin:0;background:#000;display:flex;justify-content:center;align-items:center;
  height:100vh;overflow:hidden;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;color:#fff;
}

/* Intro */
.intro{position:absolute;inset:0;background:#000;display:flex;flex-direction:column;
  justify-content:center;align-items:center;text-align:center;transition:opacity 2s ease;z-index:6;}
.intro h1{font-size:2rem;letter-spacing:1px;background:linear-gradient(90deg,var(--gravi-cyan),var(--m-blue),var(--m-purple));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;opacity:0;animation:fadeInText 3s ease forwards;}
.start-btn{margin-top:20px;background:linear-gradient(90deg,var(--m-blue),var(--m-purple));border:none;color:#fff;font-size:1rem;
  font-weight:600;padding:12px 28px;border-radius:16px;cursor:pointer;opacity:0;animation:fadeInButton 4s ease forwards;
  box-shadow:0 0 20px rgba(0,200,255,.4);transition:transform .3s,box-shadow .3s;}
.start-btn:hover{transform:scale(1.05);box-shadow:0 0 35px rgba(0,200,255,.7);}
@keyframes fadeInText{0%{opacity:0;transform:translateY(20px)}100%{opacity:1;transform:translateY(0)}}
@keyframes fadeInButton{0%{opacity:0;transform:translateY(40px)}100%{opacity:1;transform:translateY(0)}}

/* Frame aura */
.frame{position:relative;width:100vw;height:100vh;border-radius:38px;background:#000;overflow:hidden;opacity:0;transition:opacity 2s ease;}
.frame::before{content:'';position:absolute;inset:0;border-radius:38px;padding:6px;
  background:linear-gradient(120deg,var(--m-blue),var(--m-purple),var(--gravi-cyan),var(--m-red),var(--m-darkblue));
  background-size:400% 400%;-webkit-mask:linear-gradient(#000 0 0) content-box,linear-gradient(#000 0 0);
  -webkit-mask-composite:xor;mask-composite:exclude;filter:blur(6px);animation:appleAura 10s ease-in-out infinite;}
.rgb::before{animation:rgbAura 4s ease-in-out infinite;}
.frame::after{content:'';position:absolute;inset:-10px;border-radius:48px;
  background:linear-gradient(120deg,var(--m-blue),var(--m-purple),var(--m-red),var(--gravi-cyan),var(--m-darkblue));
  background-size:300% 300%;filter:blur(40px);opacity:.35;animation:auraPulse 6s ease-in-out infinite;z-index:-1;}
@keyframes appleAura{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
@keyframes rgbAura{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
@keyframes auraPulse{0%,100%{opacity:.3;filter:blur(35px)}50%{opacity:.6;filter:blur(50px)}}

/* Blur dynamic background */
.blur-bg{
  position:absolute;inset:0;
  filter:blur(120px);
  background:radial-gradient(circle at center, rgba(0,0,0,0.6), #000);
  z-index:0;
  opacity:0.6;
  transition:background 1.5s ease;
}

/* Dim saat lagu */
.dim-overlay{position:absolute;inset:0;border-radius:38px;background:rgba(0,0,0,.25);
  opacity:0;transition:opacity .6s ease;pointer-events:none;z-index:3;}
.dim-overlay.on{opacity:.45;}

/* Logout & Change Account */
.logout-btn,.change-btn{
  background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.2);color:#fff;
  padding:8px 14px;border-radius:12px;font-size:.9rem;cursor:pointer;backdrop-filter:blur(10px);
  z-index:10;transition:.3s;
}
.logout-btn:hover,.change-btn:hover{background:rgba(255,255,255,.1);}
.logout-btn{position:fixed;top:20px;left:20px;}
.change-btn{margin-top:12px;}

/* Content */
.content{position:absolute;inset:0;padding:64px 24px 100px;display:flex;flex-direction:column;
  align-items:center;gap:24px;z-index:4;overflow:auto;}
.title{font-weight:700;opacity:.9}

/* Connect */
.connect-btn{background:linear-gradient(90deg,#1db954,#1ed760);border:none;padding:12px 28px;border-radius:16px;
  font-weight:700;color:#fff;cursor:pointer;box-shadow:0 0 25px rgba(30,215,96,.4);transition:.3s;}
.connect-btn:hover{box-shadow:0 0 40px rgba(30,215,96,.8);}

/* Playlist grid */
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:18px;width:min(900px,92vw);}
.card{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08);border-radius:22px;padding:14px;
  transition:transform .25s,box-shadow .25s;backdrop-filter:blur(8px);}
.card:hover{transform:translateY(-4px) scale(1.02);box-shadow:0 10px 30px rgba(0,0,0,.45);}
.thumb{width:100%;aspect-ratio:1/1;border-radius:16px;object-fit:cover;box-shadow:0 8px 24px rgba(0,0,0,.35);}
.label{margin-top:10px;font-weight:600;opacity:.9;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;text-align:center}

/* Now Playing */
.np{display:flex;flex-direction:column;align-items:center;gap:10px;margin-top:10px;}
.np-cover{width:260px;height:260px;border-radius:22px;object-fit:cover;box-shadow:0 20px 60px rgba(0,0,0,.6);}
.np-title{font-size:1.25rem;font-weight:800;}
.np-artist{opacity:.75;}

/* Buttons bawah */
.buttons{position:fixed;bottom:18px;left:50%;transform:translateX(-50%);display:flex;gap:10px;z-index:5;}
.btn{background:rgba(30,30,30,.85);color:#fff;border:1px solid rgba(255,255,255,.2);
  padding:10px 18px;border-radius:12px;cursor:pointer;backdrop-filter:blur(10px);font-weight:600;transition:.3s;}
.btn:hover{background:rgba(255,255,255,.1);}
</style>
</head>
<body>

<div class="intro" id="intro">
  <h1>Welcome to GRAVI AI Experience</h1>
  <button class="start-btn" id="startBtn">Start Experience</button>
</div>

<div class="frame" id="frame">
  <div class="blur-bg" id="blurBg"></div>
  <div class="dim-overlay" id="dim"></div>
  <button id="logoutBtn" class="logout-btn" style="display:none;">Log Out</button>

  <div class="content" id="content">
    <h2 class="title" id="sectionTitle">Connect your Spotify</h2>
    <button id="connectSpotify" class="connect-btn">Connect Spotify</button>
    <button id="changeAccount" class="change-btn">Change Account</button>
    <div id="playlistGrid" class="grid" style="display:none;"></div>
    <div id="nowPlaying" class="np" style="display:none;">
      <img id="npCover" class="np-cover" src="" alt="">
      <div class="np-title" id="npTitle"></div>
      <div class="np-artist" id="npArtist"></div>
    </div>
  </div>
</div>

<div class="buttons">
  <button id="appleBtn" class="btn">Apple Flow</button>
  <button id="rgbBtn" class="btn">RGB Live</button>
</div>

<script>
/* UI SOUND */
const audioCtx=new(window.AudioContext||window.webkitAudioContext)();
let uiBuffer;
fetch('audio/intro.mp3').then(r=>r.arrayBuffer()).then(b=>audioCtx.decodeAudioData(b)).then(d=>uiBuffer=d);
function playUISound(v=0.3){if(!uiBuffer)return;const src=audioCtx.createBufferSource();const g=audioCtx.createGain();g.gain.value=v;src.buffer=uiBuffer;src.connect(g).connect(audioCtx.destination);src.start(0);}

/* INTRO */
const intro=document.getElementById('intro'),frame=document.getElementById('frame');
document.getElementById('startBtn').onclick=()=>{audioCtx.resume();playUISound();intro.style.opacity='0';setTimeout(()=>{intro.style.display='none';frame.style.opacity='1';},2000);}
document.getElementById('appleBtn').onclick=()=>{playUISound();frame.classList.remove('rgb');}
document.getElementById('rgbBtn').onclick=()=>{playUISound();frame.classList.add('rgb');}

/* SPOTIFY */
const CLIENT_ID="a4c46dd220374fc586a40f8450993f5a";
const REDIRECT_URI="https://inteligence-music-gravi.vercel.app/";
const SCOPES="user-read-currently-playing user-read-playback-state playlist-read-private user-library-read";
const saveT=t=>localStorage.setItem('spotify_token',t),getT=()=>localStorage.getItem('spotify_token');
const connectBtn=document.getElementById('connectSpotify');
const changeBtn=document.getElementById('changeAccount');
const logoutBtn=document.getElementById('logoutBtn');
const grid=document.getElementById('playlistGrid');
const np=document.getElementById('nowPlaying');
const npC=document.getElementById('npCover'),npT=document.getElementById('npTitle'),npA=document.getElementById('npArtist');
const dim=document.getElementById('dim'),blurBg=document.getElementById('blurBg');
const url=new URLSearchParams(location.search),code=url.get('code');

if(!code){
  const t=getT();
  if(t)onReady(t);
  else{
    connectBtn.onclick=()=>{playUISound();location.href=`https://accounts.spotify.com/authorize?client_id=${CLIENT_ID}&response_type=code&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&scope=${encodeURIComponent(SCOPES)}`;}
    changeBtn.onclick=()=>{playUISound();localStorage.removeItem('spotify_token');location.reload();}
  }
}else{
  fetch(`/api/token?code=${code}`).then(r=>r.json()).then(d=>{
    saveT(d.access_token);history.replaceState({},document.title,location.pathname);onReady(d.access_token);
  });
}

function onReady(token){
  connectBtn.style.display='none';
  changeBtn.style.display='none';
  logoutBtn.style.display='block';
  loadPlaylists(token);
  pollNowPlaying(token);
  setInterval(()=>pollNowPlaying(token),8000);
}

/* Logout */
logoutBtn.onclick=()=>{playUISound();localStorage.removeItem('spotify_token');location.reload();}

/* Load playlists */
async function loadPlaylists(t){
  grid.style.display='grid';
  grid.innerHTML="";
  grid.appendChild(makeCard({id:'__liked__',name:'Liked Songs',images:[{url:'https://i.imgur.com/0Z8FQpT.png'}]}));
  const r=await fetch(`https://api.spotify.com/v1/me/playlists?limit=50`,{headers:{Authorization:`Bearer ${t}`}});if(!r.ok)return;
  const d=await r.json();d.items.forEach(p=>grid.appendChild(makeCard(p)));
}
function makeCard(p){
  const c=document.createElement('div');
  c.className='card';
  c.onclick=()=>{playUISound();if(p.external_urls?.spotify)open(p.external_urls.spotify,'_blank');};
  const img=document.createElement('img');
  img.className='thumb';
  img.src=p.images&&p.images[0]?p.images[0].url:'https://i.imgur.com/0Z8FQpT.png';
  const lab=document.createElement('div');lab.className='label';lab.textContent=p.name||'Playlist';
  c.append(img,lab);return c;
}

/* Now Playing */
async function pollNowPlaying(t){
  try{
    const r=await fetch(`https://api.spotify.com/v1/me/player/currently-playing`,{headers:{Authorization:`Bearer ${t}`}});
    if(r.status===204){dim.classList.remove('on');np.style.display='none';return;}
    const d=await r.json();if(!d?.item)return;
    const c=d.item.album.images[0].url;
    npC.src=c;npT.textContent=d.item.name;npA.textContent=d.item.artists.map(a=>a.name).join(', ');
    np.style.display='flex';adaptAura(c);dim.classList.add('on');
  }catch(e){}
}

/* Aura color with animated blur */
function adaptAura(u){
  const i=new Image();i.crossOrigin='anonymous';i.src=u;
  i.onload=()=>{const c=document.createElement('canvas'),x=c.getContext('2d',{willReadFrequently:true});
  c.width=64;c.height=64;x.drawImage(i,0,0,64,64);
  const dt=x.getImageData(0,0,64,64).data;let r=0,g=0,b=0,cnt=0;
  for(let k=0;k<dt.length;k+=4){r+=dt[k];g+=dt[k+1];b+=dt[k+2];cnt++;}
  r=Math.round(r/cnt);g=Math.round(g/cnt);b=Math.round(b/cnt);
  const gradient=`radial-gradient(circle at center, rgba(${r},${g},${b},0.45), #000 90%)`;
  blurBg.style.background=gradient;
  frame.style.setProperty('--m-blue',`rgb(${Math.min(255,r+40)},${Math.max(0,g-10)},${Math.min(255,b+80)})`);
  frame.style.setProperty('--m-purple',`rgb(${Math.min(255,r+120)},${Math.max(0,g)},${Math.min(255,b+160)})`);
  };
}
</script>
</body>
</html>
