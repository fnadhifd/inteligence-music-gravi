<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>GRAVI AI Ã— BMW M â€“ Vision Mist Aura</title>
<style>
:root{
  --m-blue:#007bff;--m-darkblue:#002bff;--m-red:#ff003c;
  --m-purple:#a000ff;--gravi-cyan:#00fff2;--gravi-white:#e6f4ff;

  /* Apple Flow palette */
  --af-deep:#001917;
  --af-core:#002622;
  --af-cyan-soft: rgba(0,232,208,.20);
  --af-cyan-soft2: rgba(0,190,170,.16);
}
*{box-sizing:border-box}
body{
  margin:0;background:#000;display:flex;justify-content:center;align-items:center;
  height:100vh;overflow:hidden;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;color:#fff;
}

/* Intro */
.intro{position:absolute;inset:0;background:#000;display:flex;flex-direction:column;
  justify-content:center;align-items:center;text-align:center;transition:opacity 2s ease;z-index:10;}
.intro h1{font-size:2rem;letter-spacing:1px;background:linear-gradient(90deg,var(--gravi-cyan),var(--m-blue),var(--m-purple));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;opacity:0;animation:fadeInText 3s ease forwards;}
.start-btn{margin-top:20px;background:linear-gradient(90deg,var(--m-blue),var(--m-purple));border:none;color:#fff;font-size:1rem;
  font-weight:600;padding:12px 28px;border-radius:16px;cursor:pointer;opacity:0;animation:fadeInButton 4s ease forwards;
  box-shadow:0 0 20px rgba(0,200,255,.4);transition:transform .3s,box-shadow .3s;}
.start-btn:hover{transform:scale(1.05);box-shadow:0 0 35px rgba(0,200,255,.7);}
@keyframes fadeInText{0%{opacity:0;transform:translateY(20px)}100%{opacity:1;transform:translateY(0)}}
@keyframes fadeInButton{0%{opacity:0;transform:translateY(40px)}100%{opacity:1;transform:translateY(0)}}

/* Frame */
.frame{position:relative;width:100vw;height:100vh;border-radius:38px;background:#000;overflow:hidden;opacity:0;transition:opacity 2s ease;}
.frame::before{content:'';position:absolute;inset:0;border-radius:38px;padding:6px;
  background:linear-gradient(120deg,var(--m-blue),var(--m-purple),var(--gravi-cyan),var(--m-red),var(--m-darkblue));
  background-size:400% 400%;-webkit-mask:linear-gradient(#000 0 0) content-box,linear-gradient(#000 0 0);
  -webkit-mask-composite:xor;mask-composite:exclude;filter:blur(6px);animation:appleAura 10s ease-in-out infinite;}
.rgb::before{animation:rgbAura 4s ease-in-out infinite;}
.frame::after{content:'';position:absolute;inset:-10px;border-radius:48px;
  background:linear-gradient(120deg,var(--m-blue),var(--m-purple),var(--m-red),var(--gravi-cyan),var(--m-darkblue));
  background-size:300% 300%;filter:blur(40px);opacity:.35;animation:auraPulse 6s ease-in-out infinite;z-index:0;}
@keyframes appleAura{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
@keyframes rgbAura{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
@keyframes auraPulse{0%,100%{opacity:.3;filter:blur(35px)}50%{opacity:.6;filter:blur(50px)}}

/* Animated Blur Background (default) */
.blur-bg{position:absolute;inset:0;filter:blur(80px);
  background:radial-gradient(circle at 50% 50%, rgba(0,0,0,0.7), #000);
  z-index:1;transition:background 600ms ease, opacity 400ms ease;}
/* Overlay */
.dim-overlay{position:absolute;inset:0;border-radius:38px;background:rgba(0,0,0,.25);
  opacity:0;transition:opacity .4s ease;pointer-events:none;z-index:2;}
.dim-overlay.on{opacity:.45;}

/* Buttons */
.logout-btn,.change-btn{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.2);color:#fff;
  padding:8px 14px;border-radius:12px;font-size:.9rem;cursor:pointer;backdrop-filter:blur(10px);
  z-index:20;transition:.3s;margin-right:10px;}
.logout-btn:hover,.change-btn:hover{background:rgba(255,255,255,.1);}
.top-buttons{position:fixed;top:20px;left:20px;display:flex;z-index:30;}

/* Content */
.content{position:absolute;inset:0;padding:64px 24px 100px;display:flex;flex-direction:column;
  align-items:center;gap:24px;z-index:10;overflow:auto;}
.title{font-weight:700;opacity:.9}
.connect-btn{background:linear-gradient(90deg,#1db954,#1ed760);border:none;padding:12px 28px;border-radius:16px;
  font-weight:700;color:#fff;cursor:pointer;box-shadow:0 0 25px rgba(30,215,96,.4);transition:.3s;}
.connect-btn:hover{box-shadow:0 0 40px rgba(30,215,96,.8);}

/* Playlist grid */
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:18px;width:min(900px,92vw);}
.card{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08);border-radius:22px;padding:14px;
  transition:transform .25s,box-shadow .25s;backdrop-filter:blur(8px);}
.card:hover{transform:translateY(-4px) scale(1.02);box-shadow:0 10px 30px rgba(0,0,0,.45);}
.thumb{width:100%;aspect-ratio:1/1;border-radius:16px;object-fit:cover;box-shadow:0 8px 24px rgba(0,0,0,.35);}
.label{margin-top:10px;font-weight:600;opacity:.9;text-align:center;}

/* Playlist view + search */
.playlist-view{display:none;flex-direction:column;align-items:center;width:100%;animation:fadeInView .8s ease forwards;}
@keyframes fadeInView{from{opacity:0;transform:translateY(20px);}to{opacity:1;transform:translateY(0);}}
.search-bar{width:min(500px,90%);padding:10px 16px;border:none;border-radius:16px;margin-bottom:20px;
  background:rgba(255,255,255,.08);color:white;backdrop-filter:blur(8px);font-size:1rem;outline:none;}
.song-list{display:flex;flex-direction:column;gap:10px;width:min(700px,92vw);}
.song-item{display:flex;align-items:center;gap:12px;background:rgba(255,255,255,.05);padding:10px 14px;
  border-radius:14px;backdrop-filter:blur(8px);cursor:pointer;transition:background .3s,transform .2s;}
.song-item:hover{background:rgba(255,255,255,.12);transform:scale(1.02);}
.song-cover{width:50px;height:50px;border-radius:10px;object-fit:cover;}
.song-info{flex:1;}
.song-title{font-weight:600;}
.song-artist{font-size:.85rem;opacity:.7;}
.back-btn{background:rgba(255,255,255,.08);border:none;color:white;padding:10px 18px;border-radius:12px;
  margin-bottom:20px;cursor:pointer;backdrop-filter:blur(8px);font-weight:600;transition:.3s;}
.back-btn:hover{background:rgba(255,255,255,.15);}

/* Now Playing */
.np{display:flex;flex-direction:column;align-items:center;gap:10px;margin-top:10px;}
.np-cover{width:260px;height:260px;border-radius:22px;object-fit:cover;box-shadow:0 20px 60px rgba(0,0,0,.6);
  cursor:pointer;transition:transform .55s cubic-bezier(.2,.8,.2,1), box-shadow .55s;}
.np-title{font-size:1.25rem;font-weight:800;}
.np-artist{opacity:.75;}

/* Bottom buttons */
.buttons{position:fixed;bottom:18px;left:50%;transform:translateX(-50%);display:flex;gap:10px;z-index:20;}
.btn{background:rgba(30,30,30,.85);color:#fff;border:1px solid rgba(255,255,255,.2);
  padding:10px 18px;border-radius:12px;cursor:pointer;backdrop-filter:blur(10px);font-weight:600;transition:.3s;}
.btn:hover{background:rgba(255,255,255,.1);}

/* APPLE FLOW MODE (tetap sama) */
.frame.appleflow::before{animation:none;opacity:0;}
.frame.appleflow::after{
  background: radial-gradient(130% 130% at 50% 50%,rgba(0,0,0,0) 45%,rgba(0,0,0,.45) 78%,rgba(0,0,0,.75) 100%);
  filter:none;animation:none;opacity:1;
}
.frame.appleflow{background: radial-gradient(80% 80% at 50% 50%, var(--af-deep) 0%, #000 70%);}
.frame.appleflow .blur-bg{inset:-12%;background:radial-gradient(45% 45% at 52% 48%, var(--af-core) 0%, #000 70%),radial-gradient(38% 38% at 62% 42%, var(--af-cyan-soft), rgba(0,0,0,0) 70%),radial-gradient(32% 32% at 38% 62%, var(--af-cyan-soft2), rgba(0,0,0,0) 72%);filter: blur(70px);transform: rotate(0deg) scale(1.04);animation: af-rotate 32s linear infinite;opacity:.95;}
@keyframes af-rotate{from{transform:rotate(0deg) scale(1.04)}to{transform:rotate(360deg) scale(1.04)}}

/* âœ… FULLSCREEN PLAYER (APPLE MUSIC STYLE) */
.frame.fullscreen::before{opacity:0}
.frame.fullscreen::after{
  background: radial-gradient(130% 130% at 50% 50%,rgba(0,0,0,0) 40%,rgba(0,0,0,.45) 78%,rgba(0,0,0,.75) 100%);
  filter:none;animation:none;opacity:1;
}
.frame.fullscreen .content{opacity:.98;transition: opacity .35s ease;}
.frame.fullscreen .grid,.frame.fullscreen .playlist-view,.frame.fullscreen .title,.frame.fullscreen .connect-btn{opacity:0;pointer-events:none}
.frame.fullscreen .np{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:12;}
.frame.fullscreen .np-cover{width:min(70vmin,520px);height:min(70vmin,520px);transform:translateZ(0) scale(1.02);box-shadow:0 40px 120px rgba(0,0,0,.55);border-radius:24px;}
.frame.fullscreen .np-title,.frame.fullscreen .np-artist{display:block;text-align:center;margin-top:18px;}
.frame.fullscreen .np-title{font-size:1.8rem;font-weight:800;opacity:.96;}
.frame.fullscreen .np-artist{font-size:1rem;opacity:.75;margin-top:4px;}
.frame.fullscreen .blur-bg{inset:-14%;filter:blur(70px);will-change:transform,opacity;animation:fs-rotate 36s linear infinite;opacity:.96;transition:opacity .6s ease,transform .6s ease,background .8s ease;}
@keyframes fs-rotate{from{transform:rotate(0deg) scale(1.05)}to{transform:rotate(360deg) scale(1.05)}}
</style>
</head>
<body>

  
<div class="intro" id="intro">
  <h1>Welcome to GRAVI Inteligence Music Experience</h1>
  <button class="start-btn" id="startBtn">Start Experience</button>
</div>

<div class="frame" id="frame">
  <div class="blur-bg" id="blurBg"></div>
  <div class="dim-overlay" id="dim"></div>

  <div class="top-buttons" id="topButtons" style="display:none;">
    <button id="logoutBtn" class="logout-btn">Log Out</button>
    <button id="changeAccount" class="change-btn">Change Account</button>
  </div>

  <div class="content" id="content">
    <h2 class="title" id="sectionTitle">Connect your Spotify</h2>
    <button id="connectSpotify" class="connect-btn">Connect Spotify</button>
    <div id="playlistGrid" class="grid" style="display:none;"></div>

    <div id="playlistView" class="playlist-view">
      <button id="backBtn" class="back-btn">â¬… Kembali</button>
      <input id="searchBar" class="search-bar" type="text" placeholder="Cari lagu di playlist ini..."/>
      <div id="songList" class="song-list"></div>
    </div>

    <div id="nowPlaying" class="np" style="display:none;">
      <img id="npCover" class="np-cover" src="" alt="">
      <div class="np-title" id="npTitle"></div>
      <div class="np-artist" id="npArtist"></div>
    </div>
  </div>
</div>

<div class="buttons" id="bottomBtns" style="display:none;">
  <button id="appleBtn" class="btn">Apple Flow</button>
  <button id="rgbBtn" class="btn">RGB Live</button>
</div>

<script>
  /* Intro Sound */
  const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  let uiBuffer;
  fetch('audio/intro.mp3').then(r=>r.arrayBuffer()).then(b=>audioCtx.decodeAudioData(b)).then(d=>(uiBuffer=d));
  function playUISound(v=0.3){ if(!uiBuffer) return; const s=audioCtx.createBufferSource(); const g=audioCtx.createGain(); g.gain.value=v; s.buffer=uiBuffer; s.connect(g).connect(audioCtx.destination); s.start(0); }

  /* Intro */
  const intro = document.getElementById('intro'),
        frame = document.getElementById('frame'),
        bottomBtns = document.getElementById('bottomBtns');
  const blurBg = document.getElementById('blurBg');
  document.getElementById('startBtn').onclick=()=>{
    audioCtx.resume(); playUISound();
    intro.style.opacity='0';
    setTimeout(()=>{ intro.style.display='none'; frame.style.opacity='1'; bottomBtns.style.display='flex'; },2000);
  };

  /* Apple Flow â€“ toggle super ringan (restore gradient) */
  document.getElementById('appleBtn').onclick=()=>{
    playUISound();
    frame.classList.remove('rgb');
    frame.classList.toggle('appleflow');
    document.body.classList.toggle('appleflow-active');

    if(frame.classList.contains('appleflow')){
      // set ulang gradient Apple Flow
      blurBg.style.background =
        'radial-gradient(45% 45% at 52% 48%, #002622 0%, #000 70%),' +
        'radial-gradient(38% 38% at 62% 42%, rgba(0,232,208,.20), rgba(0,0,0,0) 70%),' +
        'radial-gradient(32% 32% at 38% 62%, rgba(0,190,170,.16), rgba(0,0,0,0) 72%)';
      blurBg.style.filter='blur(70px)';
      blurBg.style.animation='af-rotate 32s linear infinite';
      blurBg.style.opacity='0.95';
    }else{
      // back to default
      blurBg.style.animation='';
      blurBg.style.opacity='1';
      blurBg.style.filter='blur(80px)';
      blurBg.style.background='radial-gradient(circle at 50% 50%, rgba(0,0,0,0.7), #000)';
    }
  };

  /* RGB Mode */
  document.getElementById('rgbBtn').onclick=()=>{
    playUISound();
    frame.classList.add('rgb');
    frame.classList.remove('appleflow','fullscreen');
    document.body.classList.remove('appleflow-active');
    blurBg.style.animation=''; blurBg.style.opacity='1';
    blurBg.style.filter='blur(80px)';
    blurBg.style.background='radial-gradient(circle at 50% 50%, rgba(0,0,0,0.7), #000)';
  };

  /* Spotify Auth */
  const CLIENT_ID="a4c46dd220374fc586a40f8450993f5a";
  const REDIRECT_URI="https://inteligence-music-gravi.vercel.app/";
  const SCOPES="user-read-currently-playing user-read-playback-state playlist-read-private user-library-read";
  const saveT=t=>localStorage.setItem('spotify_token',t), getT=()=>localStorage.getItem('spotify_token');

  const connectBtn=document.getElementById('connectSpotify');
  const logoutBtn=document.getElementById('logoutBtn');
  const changeBtn=document.getElementById('changeAccount');
  const topButtons=document.getElementById('topButtons');
  const grid=document.getElementById('playlistGrid');
  const playlistView=document.getElementById('playlistView');
  const backBtn=document.getElementById('backBtn');
  const searchBar=document.getElementById('searchBar');
  const songList=document.getElementById('songList');
  const np=document.getElementById('nowPlaying');
  const npC=document.getElementById('npCover'),
        npT=document.getElementById('npTitle'),
        npA=document.getElementById('npArtist');
  const dim=document.getElementById('dim');
  let audioPreview=new Audio();
  const url=new URLSearchParams(location.search), code=url.get('code');

  if(!code){
    const t=getT();
    if(t) onReady(t);
    else{
      connectBtn.onclick=()=>{
        playUISound();
        location.href=`https://accounts.spotify.com/authorize?client_id=${CLIENT_ID}&response_type=code&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&scope=${encodeURIComponent(SCOPES)}`;
      };
    }
  }else{
    fetch(`/api/token?code=${code}`).then(r=>r.json()).then(d=>{
      saveT(d.access_token);
      history.replaceState({},document.title,location.pathname);
      onReady(d.access_token);
    });
  }

  function onReady(token){
    connectBtn.style.display='none';
    topButtons.style.display='flex';
    loadPlaylists(token);
    pollNowPlaying(token);
    setInterval(()=>pollNowPlaying(token),8000);
  }

  /* Logout & Change Account */
  logoutBtn.onclick=()=>{ playUISound(); localStorage.removeItem('spotify_token'); location.reload(); };
  changeBtn.onclick=()=>{ playUISound(); localStorage.removeItem('spotify_token');
    const authURL=`https://accounts.spotify.com/authorize?client_id=${CLIENT_ID}&response_type=code&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&scope=${encodeURIComponent(SCOPES)}&show_dialog=true`;
    window.location.href=authURL;
  };

  /* Load playlists */
  async function loadPlaylists(t){
    grid.style.display='grid'; grid.innerHTML="";
    const r=await fetch(`https://api.spotify.com/v1/me/playlists?limit=50`,{headers:{Authorization:`Bearer ${t}`}});
    if(!r.ok) return; const d=await r.json(); d.items.forEach(p=>grid.appendChild(makeCard(p)));
  }

  function makeCard(p){
    const c=document.createElement('div'); c.className='card';
    c.onclick=()=>{ playUISound(); openPlaylist(p); };
    const img=document.createElement('img'); img.className='thumb';
    img.src=p.images && p.images[0]? p.images[0].url : 'https://i.imgur.com/0Z8FQpT.png';
    const lab=document.createElement('div'); lab.className='label'; lab.textContent=p.name||'Playlist';
    c.append(img,lab); return c;
  }

  async function openPlaylist(p){
    grid.style.display='none'; playlistView.style.display='flex';
    document.getElementById('sectionTitle').textContent=p.name;
    const token=getT(); const r=await fetch(p.tracks.href,{headers:{Authorization:`Bearer ${token}`}});
    if(!r.ok) return; const d=await r.json(); renderSongs(d.items);
  }

  function renderSongs(items){
    songList.innerHTML='';
    items.forEach(i=>{
      const t=i.track; if(!t) return;
      const div=document.createElement('div'); div.className='song-item';
      const img=document.createElement('img'); img.src=t.album.images[0]?.url||''; img.className='song-cover';
      const info=document.createElement('div'); info.className='song-info';
      const title=document.createElement('div'); title.className='song-title'; title.textContent=t.name;
      const artist=document.createElement('div'); artist.className='song-artist'; artist.textContent=t.artists.map(a=>a.name).join(', ');
      info.append(title,artist); div.append(img,info);
      div.onclick=()=>playPreview(t); songList.append(div);
    });
  }

  /* Play preview */
  function playPreview(track){
    playUISound();
    if(audioPreview) audioPreview.pause();
    if(track.preview_url){ audioPreview.src=track.preview_url; audioPreview.play(); }
    else { alert("Preview lagu tidak tersedia ðŸ˜¢"); }
    const cover=track.album.images[0]?.url;
    npC.src=cover; npT.textContent=track.name; npA.textContent=track.artists.map(a=>a.name).join(', ');
    np.style.display='flex';
    adaptAura(cover);            // -> set background sesuai cover
    dim.classList.add('on');
  }

  /* Search filter */
  searchBar.addEventListener('input',()=>{
    const q=searchBar.value.toLowerCase();
    document.querySelectorAll('.song-item').forEach(it=>{
      const text=it.textContent.toLowerCase();
      it.style.display=text.includes(q)?'flex':'none';
    });
  });

  /* Back button */
  backBtn.onclick=()=>{
    playUISound();
    playlistView.style.display='none';
    grid.style.display='grid';
    document.getElementById('sectionTitle').textContent='Your Playlists';
  };

  /* Now Playing polling */
  async function pollNowPlaying(t){
    try{
      const r=await fetch(`https://api.spotify.com/v1/me/player/currently-playing`,{headers:{Authorization:`Bearer ${t}`}});
      if(r.status===204){ dim.classList.remove('on'); np.style.display='none'; return; }
      const d=await r.json(); if(!d?.item) return;
      const c=d.item.album.images[0].url;
      npC.src=c; npT.textContent=d.item.name; npA.textContent=d.item.artists.map(a=>a.name).join(', ');
      np.style.display='flex';
      adaptAura(c);
      dim.classList.add('on');
    }catch(e){}
  }

  /* ===== Fullscreen behaviour ===== */
  let lastAuraBg = ''; // simpan gradient adaptif terakhir
  function enterFullscreen(){
    frame.classList.add('fullscreen');
    // gunakan warna adaptif terakhir; jika kosong, fallback gelap
    blurBg.style.background = lastAuraBg || 'radial-gradient(circle at 50% 50%, rgba(0,0,0,.8), #000)';
    blurBg.style.animation = 'fs-rotate 36s linear infinite';
    blurBg.style.filter = 'blur(70px)';
    blurBg.style.opacity = '0.96';
  }
  function exitFullscreen(){
    frame.classList.remove('fullscreen');
    // restore sesuai mode aktif
    if(frame.classList.contains('appleflow')){
      blurBg.style.background =
        'radial-gradient(45% 45% at 52% 48%, #002622 0%, #000 70%),' +
        'radial-gradient(38% 38% at 62% 42%, rgba(0,232,208,.20), rgba(0,0,0,0) 70%),' +
        'radial-gradient(32% 32% at 38% 62%, rgba(0,190,170,.16), rgba(0,0,0,0) 72%)';
      blurBg.style.animation = 'af-rotate 32s linear infinite';
      blurBg.style.filter='blur(70px)'; blurBg.style.opacity='0.95';
    }else{
      blurBg.style.animation='';
      blurBg.style.filter='blur(80px)'; blurBg.style.opacity='1';
      blurBg.style.background='radial-gradient(circle at 50% 50%, rgba(0,0,0,0.7), #000)';
    }
  }

  // Toggle on cover click
  npC.addEventListener('click', ()=>{
    playUISound();
    if(frame.classList.contains('fullscreen')) exitFullscreen(); else enterFullscreen();
  });

  /* Aura adapt + blur â€“ generate gradient yang enak untuk fullscreen */
  function adaptAura(u){
    const i=new Image(); i.crossOrigin='anonymous'; i.src=u;
    i.onload=()=>{
      const c=document.createElement('canvas'), x=c.getContext('2d',{willReadFrequently:true});
      c.width=64; c.height=64; x.drawImage(i,0,0,64,64);
      const dt=x.getImageData(0,0,64,64).data;
      let r=0,g=0,b=0,cnt=0;
      for(let k=0;k<dt.length;k+=4){ r+=dt[k]; g+=dt[k+1]; b+=dt[k+2]; cnt++; }
      r=Math.round(r/cnt); g=Math.round(g/cnt); b=Math.round(b/cnt);
      // buat dua spot: core & highlight lembut
      lastAuraBg =
        `radial-gradient(46% 46% at 50% 50%, rgba(${r},${g},${b},0.45) 0%, rgba(0,0,0,0.92) 68%),`+
        `radial-gradient(30% 30% at 70% 40%, rgba(${r},${g},${b},0.22), rgba(0,0,0,0) 70%)`;
      // apply langsung ke blurBg (baik normal maupun fullscreen)
      blurBg.style.background = lastAuraBg;
    };
  }
</script>
</body>
</html>
